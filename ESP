#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>

const char* ssid = "IoT LAB";
const char* password = "kvt1ptit";
const char* dataURL = "https://ptitfinalproject.onrender.com/savedata";
const char* serverURL = "https://ptitfinalproject.onrender.com/api/data"; //chay ipconfig tren cmd de lay dia chi ip, cau truc la http://0.0.0.0:PORT/"ten api";
unsigned long lastSaveTime = 0;
const unsigned long saveInterval = 15UL * 60UL * 1000UL; // 15 minutes in ms

WiFiClientSecure client;
StaticJsonDocument<100> doc;

void setup() {
  client.setInsecure(); // accept HTTPS cert (OK for testing)
  Serial.begin(9600);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.println(".");
  }
  Serial.println("\nWiFi connected");
  Serial.println("IP: " + WiFi.localIP().toString());
}

void loop() {
  while (Serial.available() > 0) {
    if (WiFi.status() != WL_CONNECTED) {
      Serial.println("WiFi not connected");
      delay(1000);
      return;
    }

    HTTPClient http;
    http.begin(client, serverURL);
    http.addHeader("Content-Type", "application/json");

    String data = Serial.readStringUntil('\n');
    // Đoạn code sau deserialize để mình thêm data các kiểu, nếu không cần chỉnh data thì có thể http.POST luôn, nhưng mà nếu chỉnh xg thì phải serializeJson lại
    //DeserializationError error = deserializeJson(doc, data);

    //if (error) {
      //Serial.print("JSON parse failed: ");
      //Serial.println(error.c_str());
      //http.end();
      //return;
    //}
    int code = http.POST(data);
    if (code < 0) {
      Serial.println(http.errorToString(code));
    }
    if (code > 0) {
      Serial.printf("HTTP code: %d\n", code);

      if (code >= 400) {
        String response = http.getString();
        Serial.print("Server error body: ");
        Serial.println(response);
      }
    } 
    Serial.println(code);
    http.end();
    delay(750);
  }
}
