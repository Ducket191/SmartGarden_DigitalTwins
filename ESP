#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>

const char* ssid = "P2105";
const char* password = "10112012";
const char* dataURL = "http://192.168.1.3:5000/savedata";
const char* serverURL = "http://192.168.1.3:5000/api/data"; //chay ipconfig tren cmd de lay dia chi ip, cau truc la http://0.0.0.0:PORT/"ten api";
unsigned long lastSaveTime = 0;
const unsigned long saveInterval = 15UL * 60UL * 1000UL; // 15 minutes in ms

WiFiClient client;
StaticJsonDocument<100> doc;

void setup() {
  Serial.begin(9600);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.println(".");
  }
  Serial.println("\nWiFi connected");
  Serial.println("IP: " + WiFi.localIP().toString());
}

void loop() {
  while (Serial.available() > 0) {
    if (WiFi.status() != WL_CONNECTED) {
      Serial.println("WiFi not connected");
      delay(1000);
      return;
    }

    HTTPClient http;
    http.begin(client, serverURL);
    http.addHeader("Content-Type", "application/json");

    String data = Serial.readStringUntil('\n');
    // Đoạn code sau deserialize để mình thêm data các kiểu, nếu không cần chỉnh data thì có thể http.POST luôn, nhưng mà nếu chỉnh xg thì phải serializeJson lại
    //DeserializationError error = deserializeJson(doc, data);

    //if (error) {
      //Serial.print("JSON parse failed: ");
      //Serial.println(error.c_str());
      //http.end();
      //return;
    //}
    int code = http.POST(data);
    if (code < 0) {
      Serial.println(http.errorToString(code));
    }
    Serial.println(code);
    http.end();
    unsigned long currentTime = millis();
    if (currentTime - lastSaveTime >= saveInterval) {
      HTTPClient http2;
      http2.begin(client, dataURL);
      http2.addHeader("Content-Type", "application/json");
      int code2 = http2.POST(data);
      Serial.printf("Sent to /savedata -> code: %d\n", code2);
      http2.end();
      lastSaveTime = currentTime;
    }
    delay(750);
  }
}
